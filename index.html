4|18.557064994994178|59.04765298116674|17.423409962922847|59.09059426535934|17.566975623932805|59.07252503543983|17.6171904734812|59.19268998716846|17.664919881103362|59.294207816916405|17.41040343048321|59.194871100068475|17.729736182238913|59.02596098336056|17.551112298946514|59.17644357189293|17.433250791412593|59.05731491616438|16.591440049797544|59.244883928341956|18.09046924378434|59.24933718600431|18.057576999741865|59.23616382556451|18.090339651576837|59.24085194674837|18.11229593170952
Jesper Franz√©n,59.25269908943464,18.038921055308524,#D998A0,Tv√§ttstugor,59.30292905246633|17.970388293584236|59.276212598862735|18.13410418745026|59.27469568808272|18.007164880442353|59.27915053350937|18.05321927822656|59.213696402453614|18.1446727712502|59.26885382967369|18.04976095330383|59.235955290825736|17.977174021275513|59.29449323100616|18.08110432085998|59.28984352691386|18.06854337026992|59.25607230522263|18.031684561228175|59.26232114496639|18.045608664042877|59.23719427760765|18.240171221991858|59.25718767407696|18.116927593812207|59.232683880059156|18.137624498170464|59.25515955571409|18.081527124099416|59.26697882427356|18.13033238119442|59.253197684938804|18.163665460905218|59.26232114496639|18.045608664042877`;

function applyOffset(latlng, key){
  if(!addressOffsets[key]) addressOffsets[key]=0;
  const offset = 0.00135 * addressOffsets[key];
  addressOffsets[key]++;
  return [latlng[0]+offset, latlng[1]];
}

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

async function loadCSV(){
  loadingContainer.style.display = "block";
  loadingBar.style.width = "0%";
  loadingBar.textContent = "0%";

  allMarkers.forEach(o => map.removeLayer(o.marker));
  allMarkers = [];
  addressOffsets = {};
  technicians = [];

  const rows = Papa.parse(csvData,{header:true,skipEmptyLines:true}).data;

  let total = 0;
  rows.forEach(r => {
    const addressStr = r.adresser ? r.adresser.trim() : "";
    const addressCount = addressStr ? (addressStr.split("|").length / 2) : 0;
    total += 1 + addressCount;
  });
  let loaded = 0;

  function updateLoading(){
    const p = Math.round((loaded/total)*100);
    loadingBar.style.width = p+"%";
    loadingBar.textContent = p+"%";
  }

  for(const row of rows){
    const name = row.namn;
    const homeLat = parseFloat(row.hemadress_lat);
    const homeLon = parseFloat(row.hemadress_lon);
    const color = row.f√§rg || "#ff0000";
    const resource = row.resurs || "";

    const addressStr = row.adresser ? row.adresser.trim() : "";
    const addressList = [];

    if(addressStr){
      const coords = addressStr.split("|");
      for(let i = 0; i < coords.length; i += 2){
        if(i+1 < coords.length){
          const lat = parseFloat(coords[i]);
          const lon = parseFloat(coords[i+1]);
          if(!isNaN(lat) && !isNaN(lon)){
            addressList.push({lat, lon});
          }
        }
      }
    }

    technicians.push({ name, color, resource, home:{lat: homeLat, lon: homeLon}, addresses:addressList });

    const homeKey = `${homeLat},${homeLon}`;
    const adj = applyOffset([homeLat, homeLon], homeKey);
    const marker = L.marker(adj,{
      icon:L.divIcon({
        html:"üè†",
        className:"transparent-icon",
        iconSize:[50,50],
        iconAnchor:[25,25]
      })
    })
    .addTo(map)
    .bindTooltip(`${name}<br>${resource}`,{permanent:true,direction:"right",className:"house-label",offset:[10,0]});
    const el = marker.getTooltip().getElement();
    if(el){ el.style.backgroundColor = color; el.style.color = "#fff"; }
    allMarkers.push({ marker, techName: name, resource });
    loaded++; updateLoading();
    await sleep(50);

    for(const addr of addressList){
      const addrKey = `${addr.lat},${addr.lon}`;
      const adj = applyOffset([addr.lat, addr.lon], addrKey);
      const marker = L.marker(adj,{
        icon:L.divIcon({
          html:"üìç",
          className:"transparent-icon",
          iconSize:[50,50],
          iconAnchor:[25,25]
        })
      })
      .addTo(map)
      .bindTooltip(`${name}<br>${resource}`,{permanent:true,direction:"right",className:"house-label",offset:[10,0]});
      const el = marker.getTooltip().getElement();
      if(el){ el.style.backgroundColor = color; el.style.color = "#fff"; }
      allMarkers.push({ marker, techName: name, resource });
      loaded++; updateLoading();
      await sleep(50);
    }
  }

  renderTechnicianList();
  renderColorPanel();
  applyResourceFilter();

  loadingBar.style.width = "100%";
  loadingBar.textContent = "100%";
  setTimeout(() => {
    loadingContainer.style.display = "none";
    document.getElementById("search-box").style.display = "flex";
    document.getElementById("control-panel").style.display = "block";
  }, 300);
}

function renderColorPanel(){
  const p = document.getElementById("color-panel");
  p.innerHTML="";
  technicians.forEach((t,i)=>{
    const d = document.createElement("div");
    d.className="tech-color";
    d.id="tech-color-"+i;
    d.dataset.techName = t.name;
    d.dataset.resource = t.resource;
    d.innerHTML = `<div class="tech-color-box" style="background:${t.color}"></div>${t.name}`;
    d.onclick = () => toggleTechnicianFilter(t.name);
    p.appendChild(d);
  });
}

function toggleTechnicianFilter(name){
  if(selectedTechnician === name){
    selectedTechnician = null;
  } else {
    selectedTechnician = name;
  }
  applyResourceFilter();
}

function renderTechnicianList(){
  const c = document.getElementById("technician-list");
  c.innerHTML="";
  technicians.forEach(t=>{
    const addressStr = t.addresses.length > 0 ? t.addresses.map(a => `${a.lat.toFixed(4)}, ${a.lon.toFixed(4)}`).join("; ") : "Ingen";
    const d = document.createElement("div");
    d.innerHTML = `<strong>${t.name}</strong><br>Hem: ${t.home.lat.toFixed(4)}, ${t.home.lon.toFixed(4)}<br>Resurs: ${t.resource}<br>Adresser: ${addressStr}`;
    c.appendChild(d);
  });
}

async function searchAddress(){
  const q = document.getElementById("address-input").value;
  if(!q) return alert("Skriv en adress");

  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
  const res = await fetch(url,{headers:{ "User-Agent":"ErgonovaTekniker/1.0" }});
  const data = await res.json();
  if(!data.length) return alert("Adressen hittades inte");

  const coords = [parseFloat(data[0].lat), parseFloat(data[0].lon)];

  if(searchMarker){ map.removeLayer(searchMarker); searchMarker = null; }

  searchMarker = L.marker(coords, {
    icon: L.divIcon({ html: "üîµ", className: "transparent-icon", iconSize: [50,50], iconAnchor:[25,25] })
  }).addTo(map).bindTooltip(q,{permanent:true,direction:"top",className:"house-label",offset:[0,-10]});

  const el = searchMarker.getTooltip().getElement();
  if(el){ el.style.backgroundColor="#2196F3"; el.style.color="#fff"; }

  map.setView(coords, 15);

  const distances = allMarkers.map(o=>{
    const ll = o.marker.getLatLng();
    return { techName: o.techName, distance: Math.hypot(ll.lat-coords[0], ll.lng-coords[1]) };
  });

  distances.sort((a,b)=>a.distance-b.distance);
  const nearestTwo = distances.slice(0,3).map(d=>d.techName);

  technicians.forEach((t,i)=>{
    const el = document.getElementById("tech-color-"+i);
    if(el && t.name !== selectedTechnician){
      el.style.backgroundColor = "white";
      el.style.color = "#000";
    }
  });

  technicians.forEach((t,i)=>{
    if(nearestTwo.includes(t.name) && t.name !== selectedTechnician){
      const el = document.getElementById("tech-color-"+i);
      if(el){ el.style.backgroundColor="#FF5C00"; el.style.color="#000"; }
    }
  });
}

function resetSearch() {
  if(searchMarker){
    map.removeLayer(searchMarker);
    searchMarker = null;
  }
  technicians.forEach((t,i)=>{
    const el = document.getElementById("tech-color-"+i);
    if(el){
      el.style.backgroundColor = "white";
      el.style.color = "#000";
    }
  });
  selectedTechnician = null;
  applyResourceFilter();
  document.getElementById("address-input").value = "";
  map.setView(initialView.center, initialView.zoom);
}

function applyResourceFilter(){
  const vitvarorChecked = document.getElementById("filter-vitvaror").checked;
  const tvattstugorChecked = document.getElementById("filter-tvattstugor").checked;

  allMarkers.forEach(o=>{
    let show = true;

    if(selectedTechnician){
      show = o.techName === selectedTechnician;
    } else if(vitvarorChecked && !tvattstugorChecked){
      show = o.resource.toLowerCase().includes("vitvar");
    } else if(!vitvarorChecked && tvattstugorChecked){
      show = o.resource.toLowerCase().includes("tv√§tt");
    } else if(vitvarorChecked && tvattstugorChecked){
      show = true;
    } else {
      show = false;
    }

    if(show){ if(!map.hasLayer(o.marker)) o.marker.addTo(map); }
    else { if(map.hasLayer(o.marker)) map.removeLayer(o.marker); }
  });

  technicians.forEach((t,i)=>{
    const el = document.getElementById("tech-color-"+i);
    if(el){
      if(selectedTechnician){
        el.style.display = (t.name === selectedTechnician) ? "flex" : "none";
      } else {
        const match = (vitvarorChecked && t.resource.toLowerCase().includes("vitvar")) ||
                      (tvattstugorChecked && t.resource.toLowerCase().includes("tv√§tt"));
        el.style.display = match ? "flex" : "none";
      }
    }
  });
}

document.getElementById("filter-vitvaror").addEventListener("change", applyResourceFilter);
document.getElementById("filter-tvattstugor").addEventListener("change", applyResourceFilter);

document.getElementById("address-input").addEventListener("keypress", function(e){
  if(e.key === "Enter"){
    searchAddress();
  }
});

const coll = document.querySelector(".collapsible");
coll.onclick = function(){
  this.classList.toggle("active");
  const c = this.nextElementSibling;
  c.style.display = c.style.display==="block"?"none":"block";
}

window.addEventListener("DOMContentLoaded", loadCSV);
</script>

</body>
</html>
