
<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<title>Tekniker ‚Äì omr√•den & hem</title>

<link rel="icon" type="image/x-icon" href="https://perkanboy.github.io/Teknikerlista/favicon.ico">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body { margin: 0; font-family: Arial, sans-serif; }
#map { height: 100vh; }

.house-label {
  font-weight: bold;
  padding: 4px 8px;
  border-radius: 4px;
  border: 1px solid #666;
  white-space: nowrap;
  font-size: 13px;
  color: #fff;
}

/* F√§rgpanel l√§ngst upp */
#color-panel {
  position: absolute;
  top: 10px;
  left: 10px;
  right: 10px;
  padding: 5px 10px;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  background: rgba(255,255,255,0.4); /* lite transparent */
  backdrop-filter: blur(6px); /* mjuk blur f√∂r kartan bakom */
  border-radius: 8px;
  z-index: 1000;
  font-size: 14px;
  box-shadow: 0 0 6px rgba(0,0,0,0.3);
}

.tech-color {
  display:flex;
  align-items:center;
  gap:4px;
  padding:4px 6px;
  border-radius:4px;
  color:#000;
  font-weight:bold;
  border:1px solid #666;
  background-color: white;
  cursor: pointer;
  transition: background 0.3s;
}
.tech-color-box { width:20px; height:20px; border-radius:4px; border:1px solid #333; }

#search-box {
  position: absolute;
  top: 90px;
  left: 10px;
  width: 300px;
  display: flex;
  gap: 5px;
  z-index: 1000;
}
#search-box input { flex: 1; padding:6px; border-radius:4px; border:1px solid #999; }
#search-box button { padding:6px 10px; border-radius:4px; border:none; background-color:#4CAF50; color:white; cursor:pointer; transition: background 0.3s; }
#search-box button:hover { background-color:#45a049; }

#control-panel {
  position: absolute;
  top: 140px;
  left: 10px;
  background: rgba(255,255,255,0.4); /* lite transparent */
  backdrop-filter: blur(6px); /* mjuk blur f√∂r kartan bakom */
  padding: 8px;
  border-radius: 8px;
  box-shadow: 0 0 6px rgba(0,0,0,0.3);
  max-height: 60vh;
  overflow-y: auto;
  font-size: 14px;
  z-index: 1000;
  width: 300px;
}

.filter-panel {
  margin-bottom: 10px;
  padding: 8px;
  border-radius: 6px;
  background: #f5f5f5;
  border: 1px solid #ddd;
}
.filter-panel label {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  margin-bottom: 6px;
  font-weight: bold;
}
.filter-panel input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: #2196F3;
  cursor: pointer;
}

.collapsible {
  background-color: #f1f1f1;
  color: #444;
  cursor: pointer;
  padding: 10px;
  width: 100%;
  border: none;
  text-align: left;
  outline: none;
  font-size: 16px;
  border-radius: 6px;
  margin-bottom: 6px;
}
.active, .collapsible:hover { background-color: #ddd; }
.content { padding: 0 10px; display: none; overflow: hidden; }

#reload-button {
  display:block;
  width:100%;
  padding:6px;
  margin-bottom:10px;
  border:none;
  background-color:#2196F3;
  color:white;
  border-radius:4px;
  cursor:pointer;
  font-weight:bold;
}
#reload-button:hover { background-color:#1976D2; }

#loading-container {
  position: absolute;
  top: 60px;          /* beh√•ller h√∂jden fr√•n toppen */
  left: 50%;          /* placera mitten av elementet vid mitten av sk√§rmen */
  transform: translateX(-50%); /* justerar s√• att det verkligen blir centrerat */
  width: 300px;
  height: 26px;
  background: #ddd;
  border-radius: 6px;
  overflow: hidden;
  z-index: 1001;
  display: none;
}

#loading-bar {
  height:100%;
  width:0%;
  background:#4CAF50;
  display:flex;
  align-items:center;
  justify-content:center;
  color:black;
  font-weight:bold;
  transition: width 0.2s;
}

.transparent-icon {
  background: transparent;
  font-size: 32px;
  text-align: center;
  line-height: 32px;
}

#search-box, #control-panel { display: none; }
</style>
</head>

<body>

<div id="color-panel"></div>
<div id="map"></div>

<div id="loading-container">
  <div id="loading-bar">0%</div>
</div>

<div id="search-box">
  <input type="text" id="address-input" placeholder="S√∂k adress...">
  <button onclick="searchAddress()">S√∂k</button>
  <button id="reset-button" onclick="resetSearch()">√Öterst√§ll</button>
</div>

<div id="control-panel">

  <div class="filter-panel">
    <label>
      <input type="checkbox" id="filter-vitvaror" checked>
      Vitvaror
    </label>
    <label>
      <input type="checkbox" id="filter-tvattstugor" checked>
      Tv√§ttstugor
    </label>
  </div>

  <button type="button" class="collapsible nice-button">
    <span>Teknikerlista</span>
    <span class="arrow">‚ñº</span>
  </button>
  <div class="content">
    <button id="reload-button" onclick="loadCSV()">Ladda om tekniker</button>
    <div id="technician-list"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
const map = L.map("map", { zoomControl: false }).setView([59.33, 18.06], 9);
L.control.zoom({ position: "bottomright" }).addTo(map);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{ attribution: "¬© OpenStreetMap"}).addTo(map);

let technicians = [];
let allMarkers = [];
let addressOffsets = {};
let selectedTechnician = null;
const initialView = { center:[59.33,18.06], zoom:9 };

const loadingContainer = document.getElementById("loading-container");
const loadingBar = document.getElementById("loading-bar");
let searchMarker = null;

const csvData = `namn,hemadress_lat,hemadress_lon,f√§rg,resurs,adresser
Aleksandar Tatic,59.24393950736054,18.203615126473327,#000000,Vitvaror (Sjukskriven),
Ali Melek,59.50333696108488,17.754223182293646,#595959,Vitvaror,59.263541093199144|17.88756397848849|59.246551926468996|17.823165381004635|59.20043407638811|17.826192723662817|59.27372868027259|17.900744322939264|59.21102319185396|17.898853435142776|59.22377206932267|17.93885093008406|59.25036205053355|17.864928038259894|59.29480000979702|17.934879357275232|59.167291514861105|17.851265537526665|59.24385981202894|17.970139643872038|59.234228275141675|17.85138058760232|59.24622275681167|17.82325121168368|59.25940724520993|17.885865326798974
Daniell Jakobsen,59.214106000500294,17.66234003996703,#a6a6a6,Vitvaror,59.189362683537944|17.627354719788514|59.04765298116674|17.423409962922847|59.09059426535934|17.566975623932805|59.07252503543983|17.6171904734812|59.19268998716846|17.664919881103362|59.294207816916405|17.41040343048321|59.194871100068475|17.729736182238913|59.02596098336056|17.551112298946514|59.17644357189293|17.433250791412593|59.05731491616438|16.591440049797544
Jesper Wel√©n,59.6389547747678,18.6564320264941,Blue,Vitvaror,59.23616382556451|18.090339651576837|59.244883928341956|18.09046924378434|59.24933718600431|18.057576999741865
Peter Viking,59.35975073881764,17.837895282304977,Red,Vitvaror + Micasa,59.38134908136288|17.975827839975853|59.346628846739556|18.071532220189983|59.37229916989014|17.843326132547926|59.38347909475894|17.90372847878339|59.37892684102438|17.95951460320444|59.34572725172864|17.933815554705934|59.36655330235911|18.16240557006817|59.401897822663976|17.946078650853057|59.367754892845355|17.870331979302637
Tobias Jepsen,59.32427424302387,18.070639672645495,#CC338B,Vitvaror (Alla Husf),59.30292905246633|17.970388293584236|59.276212598862735|18.13410418745026|59.27469568808272|18.007164880442353|59.27915053350937|18.05321927822656|59.213696402453614|18.1446727712502|59.26885382967369|18.04976095330383|59.235955290825736|17.977174021275513|59.29449323100616|18.08110432085998|59.28984352691386|18.06854337026992|59.25607230522263|18.031684561228175|59.26232114496639|18.045608664042877|59.23719427760765|18.240171221991858
Ulf Ekman,59.167352373412946,18.14247495530403,Green,Vitvaror,59.189362683537944|17.627354719788514|59.04765298116674|17.423409962922847|59.09059426535934|17.566975623932805|59.07252503543983|17.6171904734812|59.19268998716846|17.664919881103362|59.294207816916405|17.41040343048321|59.194871100068475|17.729736182238913|59.02596098336056|17.551112298946514|59.17644357189293|17.433250791412593|59.05731491616438|16.591440049797544|59.177545016180645|18.141584842303|59.14734854394963|18.117352872751503|59.14839885901763|18.43469824222235|59.1803511331101|18.180301934930615|58.95018914318855|18.281215282024387|59.14839885901763|18.43469824222235|59.1180724100685|18.111858200953957|59.10297804469301|18.044693311562742|59.20033597009178|18.196576826984526|59.1180724100685|18.111858200953957|59.14839885901763|18.43469824222235|59.18826958896172|18.13180699629523
Mehmet,59.617183095627915,17.82230879765811,Brown,Tv√§ttstugor + Micasa,59.51465527042406|17.93167882886477|59.37229916989014|17.843326132547926|59.38347909475894|17.90372847878339|59.37892684102438|17.95951460320444|59.34572725172864|17.933815554705934|59.36655330235911|18.16240557006817|59.401897822663976|17.946078650853057|59.367754892845355|17.870331979302637|59.38134908136288|17.975827839975853
Dan Svegemo,59.375489678527444,18.18448582648017,#E9967A,Tv√§ttstugor,59.346628846739556|18.071532220189983|59.36655330235911|18.16240557006817|59.37065849375133|18.01087158260539
Erol Baysal,59.20282788138683,17.80381596880129,#7FFFD4,Tv√§ttstugor,59.25940724520993|17.885865326798974|59.24622275681167|17.82325121168368|59.20043407638811|17.826192723662817|59.27372868027259|17.900744322939264|59.21102319185396|17.898853435142776|59.22377206932267|17.93885093008406|59.25036205053355|17.864928038259894|59.29480000979702|17.934879357275232|59.167291514861105|17.851265537526665|59.24385981202894|17.970139643872038|59.234228275141675|17.85138058760232
Patrik Edqvist,59.16652777752203,17.446806297634264,#90EE90,Tv√§ttstugor/Vitvaror,58.90081369755542|17.551539884700514|59.17644357189293|17.433250791412593
Lars Borg,59.13063516496917,18.102629182292805,#808000,Tv√§ttstugor,59.321104890294414|18.557064994994178|59.04765298116674|17.423409962922847|59.09059426535934|17.566975623932805|59.07252503543983|17.6171904734812|59.19268998716846|17.664919881103362|59.294207816916405|17.41040343048321|59.194871100068475|17.729736182238913|59.02596098336056|17.551112298946514|59.17644357189293|17.433250791412593|59.05731491616438|16.591440049797544|59.244883928341956|18.09046924378434|59.24933718600431|18.057576999741865|59.23616382556451|18.090339651576837|59.24085194674837|18.11229593170952
Jesper Franz√©n,59.25269908943464,18.038921055308524,#D998A0,Tv√§ttstugor,59.30292905246633|17.970388293584236|59.276212598862735|18.13410418745026|59.27469568808272|18.007164880442353|59.27915053350937|18.05321927822656|59.213696402453614|18.1446727712502|59.26885382967369|18.04976095330383|59.235955290825736|17.977174021275513|59.29449323100616|18.08110432085998|59.28984352691386|18.06854337026992|59.25607230522263|18.031684561228175|59.26232114496639|18.045608664042877|59.23719427760765|18.240171221991858|59.25718767407696|18.116927593812207|59.232683880059156|18.137624498170464|59.25515955571409|18.081527124099416|59.26697882427356|18.13033238119442|59.253197684938804|18.163665460905218|59.26232114496639|18.045608664042877`;

function applyOffset(latlng, key){
  if(!addressOffsets[key]) addressOffsets[key]=0;
  const offset = 0.00135 * addressOffsets[key];
  addressOffsets[key]++;
  return [latlng[0]+offset, latlng[1]];
}

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

async function loadCSV(){
  loadingContainer.style.display = "block";
  loadingBar.style.width = "0%";
  loadingBar.textContent = "0%";

  allMarkers.forEach(o => map.removeLayer(o.marker));
  allMarkers = [];
  addressOffsets = {};
  technicians = [];

  const rows = Papa.parse(csvData,{header:true,skipEmptyLines:true}).data;

  let total = 0;
  rows.forEach(r => {
    const addressStr = r.adresser ? r.adresser.trim() : "";
    const addressCount = addressStr ? (addressStr.split("|").length / 2) : 0;
    total += 1 + addressCount;
  });
  let loaded = 0;

  function updateLoading(){
    const p = Math.round((loaded/total)*100);
    loadingBar.style.width = p+"%";
    loadingBar.textContent = p+"%";
  }

  for(const row of rows){
    const name = row.namn;
    const homeLat = parseFloat(row.hemadress_lat);
    const homeLon = parseFloat(row.hemadress_lon);
    const color = row.f√§rg || "#ff0000";
    const resource = row.resurs || "";

    const addressStr = row.adresser ? row.adresser.trim() : "";
    const addressList = [];

    if(addressStr){
      const coords = addressStr.split("|");
      for(let i = 0; i < coords.length; i += 2){
        if(i+1 < coords.length){
          const lat = parseFloat(coords[i]);
          const lon = parseFloat(coords[i+1]);
          if(!isNaN(lat) && !isNaN(lon)){
            addressList.push({lat, lon});
          }
        }
      }
    }

    technicians.push({ name, color, resource, home:{lat: homeLat, lon: homeLon}, addresses:addressList });

    const homeKey = `${homeLat},${homeLon}`;
    const adj = applyOffset([homeLat, homeLon], homeKey);
    const marker = L.marker(adj,{
      icon:L.divIcon({
        html:"üè†",
        className:"transparent-icon",
        iconSize:[50,50],
        iconAnchor:[25,25]
      })
    })
    .addTo(map)
    .bindTooltip(`${name}<br>${resource}`,{permanent:true,direction:"right",className:"house-label",offset:[10,0]});
    const el = marker.getTooltip().getElement();
    if(el){ el.style.backgroundColor = color; el.style.color = "#fff"; }
    allMarkers.push({ marker, techName: name, resource });
    loaded++; updateLoading();
    await sleep(50);

    for(const addr of addressList){
      const addrKey = `${addr.lat},${addr.lon}`;
      const adj = applyOffset([addr.lat, addr.lon], addrKey);
      const marker = L.marker(adj,{
        icon:L.divIcon({
          html:"üìç",
          className:"transparent-icon",
          iconSize:[50,50],
          iconAnchor:[25,25]
        })
      })
      .addTo(map)
      .bindTooltip(`${name}<br>${resource}`,{permanent:true,direction:"right",className:"house-label",offset:[10,0]});
      const el = marker.getTooltip().getElement();
      if(el){ el.style.backgroundColor = color; el.style.color = "#fff"; }
      allMarkers.push({ marker, techName: name, resource });
      loaded++; updateLoading();
      await sleep(50);
    }
  }

  renderTechnicianList();
  renderColorPanel();
  applyResourceFilter();

  loadingBar.style.width = "100%";
  loadingBar.textContent = "100%";
  setTimeout(() => {
    loadingContainer.style.display = "none";
    document.getElementById("search-box").style.display = "flex";
    document.getElementById("control-panel").style.display = "block";
  }, 300);
}

function renderColorPanel(){
  const p = document.getElementById("color-panel");
  p.innerHTML="";
  technicians.forEach((t,i)=>{
    const d = document.createElement("div");
    d.className="tech-color";
    d.id="tech-color-"+i;
    d.dataset.techName = t.name;
    d.dataset.resource = t.resource;
    d.innerHTML = `<div class="tech-color-box" style="background:${t.color}"></div>${t.name}`;
    d.onclick = () => toggleTechnicianFilter(t.name);
    p.appendChild(d);
  });
}

function toggleTechnicianFilter(name){
  if(selectedTechnician === name){
    selectedTechnician = null;
  } else {
    selectedTechnician = name;
  }
  applyResourceFilter();
}

function renderTechnicianList(){
  const c = document.getElementById("technician-list");
  c.innerHTML="";
  technicians.forEach(t=>{
    const addressStr = t.addresses.length > 0 ? t.addresses.map(a => `${a.lat.toFixed(4)}, ${a.lon.toFixed(4)}`).join("; ") : "Ingen";
    const d = document.createElement("div");
    d.innerHTML = `<strong>${t.name}</strong><br>Hem: ${t.home.lat.toFixed(4)}, ${t.home.lon.toFixed(4)}<br>Resurs: ${t.resource}<br>Adresser: ${addressStr}`;
    c.appendChild(d);
  });
}

async function searchAddress(){
  const q = document.getElementById("address-input").value;
  if(!q) return alert("Skriv en adress");

  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
  const res = await fetch(url,{headers:{ "User-Agent":"ErgonovaTekniker/1.0" }});
  const data = await res.json();
  if(!data.length) return alert("Adressen hittades inte");

  const coords = [parseFloat(data[0].lat), parseFloat(data[0].lon)];

  if(searchMarker){ map.removeLayer(searchMarker); searchMarker = null; }

  searchMarker = L.marker(coords, {
    icon: L.divIcon({ html: "üîµ", className: "transparent-icon", iconSize: [50,50], iconAnchor:[25,25] })
  }).addTo(map).bindTooltip(q,{permanent:true,direction:"top",className:"house-label",offset:[0,-10]});

  const el = searchMarker.getTooltip().getElement();
  if(el){ el.style.backgroundColor="#2196F3"; el.style.color="#fff"; }

  map.setView(coords, 15);

  const distances = allMarkers.map(o=>{
    const ll = o.marker.getLatLng();
    return { techName: o.techName, distance: Math.hypot(ll.lat-coords[0], ll.lng-coords[1]) };
  });

  distances.sort((a,b)=>a.distance-b.distance);
  const nearestTwo = distances.slice(0,3).map(d=>d.techName);

  technicians.forEach((t,i)=>{
    const el = document.getElementById("tech-color-"+i);
    if(el && t.name !== selectedTechnician){
      el.style.backgroundColor = "white";
      el.style.color = "#000";
    }
  });

  technicians.forEach((t,i)=>{
    if(nearestTwo.includes(t.name) && t.name !== selectedTechnician){
      const el = document.getElementById("tech-color-"+i);
      if(el){ el.style.backgroundColor="#FF5C00"; el.style.color="#000"; }
    }
  });
}

function resetSearch() {
  if(searchMarker){
    map.removeLayer(searchMarker);
    searchMarker = null;
  }
  technicians.forEach((t,i)=>{
    const el = document.getElementById("tech-color-"+i);
    if(el){
      el.style.backgroundColor = "white";
      el.style.color = "#000";
    }
  });
  selectedTechnician = null;
  applyResourceFilter();
  document.getElementById("address-input").value = "";
  map.setView(initialView.center, initialView.zoom);
}

function applyResourceFilter(){
  const vitvarorChecked = document.getElementById("filter-vitvaror").checked;
  const tvattstugorChecked = document.getElementById("filter-tvattstugor").checked;

  allMarkers.forEach(o=>{
    let show = true;

    if(selectedTechnician){
      show = o.techName === selectedTechnician;
    } else if(vitvarorChecked && !tvattstugorChecked){
      show = o.resource.toLowerCase().includes("vitvar");
    } else if(!vitvarorChecked && tvattstugorChecked){
      show = o.resource.toLowerCase().includes("tv√§tt");
    } else if(vitvarorChecked && tvattstugorChecked){
      show = true;
    } else {
      show = false;
    }

    if(show){ if(!map.hasLayer(o.marker)) o.marker.addTo(map); }
    else { if(map.hasLayer(o.marker)) map.removeLayer(o.marker); }
  });

  technicians.forEach((t,i)=>{
    const el = document.getElementById("tech-color-"+i);
    if(el){
      if(selectedTechnician){
        el.style.display = (t.name === selectedTechnician) ? "flex" : "none";
      } else {
        const match = (vitvarorChecked && t.resource.toLowerCase().includes("vitvar")) ||
                      (tvattstugorChecked && t.resource.toLowerCase().includes("tv√§tt"));
        el.style.display = match ? "flex" : "none";
      }
    }
  });
}

document.getElementById("filter-vitvaror").addEventListener("change", applyResourceFilter);
document.getElementById("filter-tvattstugor").addEventListener("change", applyResourceFilter);

document.getElementById("address-input").addEventListener("keypress", function(e){
  if(e.key === "Enter"){
    searchAddress();
  }
});

const coll = document.querySelector(".collapsible");
coll.onclick = function(){
  this.classList.toggle("active");
  const c = this.nextElementSibling;
  c.style.display = c.style.display==="block"?"none":"block";
}

window.addEventListener("DOMContentLoaded", loadCSV);
</script>

</body>
</html>





