<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<title>Tekniker ‚Äì omr√•den & hem</title>

<link rel="icon" type="image/x-icon" href="https://perkanboy.github.io/Teknikerlista/favicon.ico">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body { margin: 0; font-family: Arial, sans-serif; }
#map { height: 100vh; }

.house-label {
  font-weight: bold;
  padding: 4px 8px;
  border-radius: 4px;
  border: 1px solid #666;
  white-space: nowrap;
  font-size: 13px;
  color: #fff;
}

/* F√§rgpanel l√§ngst upp */
#color-panel {
  position: absolute;
  top: 10px;
  left: 10px;
  right: 10px;
  padding: 5px 10px;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  background: rgba(255,255,255,0.4); /* lite transparent */
  backdrop-filter: blur(6px); /* mjuk blur f√∂r kartan bakom */
  border-radius: 8px;
  z-index: 1000;
  font-size: 14px;
  box-shadow: 0 0 6px rgba(0,0,0,0.3);
}

.tech-color {
  display:flex;
  align-items:center;
  gap:4px;
  padding:4px 6px;
  border-radius:4px;
  color:#000;
  font-weight:bold;
  border:1px solid #666;
  background-color: white;
  cursor: pointer;
  transition: background 0.3s;
}
.tech-color-box { width:20px; height:20px; border-radius:4px; border:1px solid #333; }

#search-box {
  position: absolute;
  top: 90px;
  left: 10px;
  width: 300px;
  display: flex;
  gap: 5px;
  z-index: 1000;
}
#search-box input { flex: 1; padding:6px; border-radius:4px; border:1px solid #999; }
#search-box button { padding:6px 10px; border-radius:4px; border:none; background-color:#4CAF50; color:white; cursor:pointer; transition: background 0.3s; }
#search-box button:hover { background-color:#45a049; }

#control-panel {
  position: absolute;
  top: 140px;
  left: 10px;
  background: rgba(255,255,255,0.4); /* lite transparent */
  backdrop-filter: blur(6px); /* mjuk blur f√∂r kartan bakom */
  padding: 8px;
  border-radius: 8px;
  box-shadow: 0 0 6px rgba(0,0,0,0.3);
  max-height: 60vh;
  overflow-y: auto;
  font-size: 14px;
  z-index: 1000;
  width: 300px;
}

.filter-panel {
  margin-bottom: 10px;
  padding: 8px;
  border-radius: 6px;
  background: #f5f5f5;
  border: 1px solid #ddd;
}
.filter-panel label {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  margin-bottom: 6px;
  font-weight: bold;
}
.filter-panel input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: #2196F3;
  cursor: pointer;
}

.collapsible {
  background-color: #f1f1f1;
  color: #444;
  cursor: pointer;
  padding: 10px;
  width: 100%;
  border: none;
  text-align: left;
  outline: none;
  font-size: 16px;
  border-radius: 6px;
  margin-bottom: 6px;
}
.active, .collapsible:hover { background-color: #ddd; }
.content { padding: 0 10px; display: none; overflow: hidden; }

#reload-button {
  display:block;
  width:100%;
  padding:6px;
  margin-bottom:10px;
  border:none;
  background-color:#2196F3;
  color:white;
  border-radius:4px;
  cursor:pointer;
  font-weight:bold;
}
#reload-button:hover { background-color:#1976D2; }

#loading-container {
  position:absolute;
  top: 60px;
  left: 10px;
  width:300px;
  height:26px;
  background:#ddd;
  border-radius:6px;
  overflow:hidden;
  z-index:1001;
  display:none;
}
#loading-bar {
  height:100%;
  width:0%;
  background:#4CAF50;
  display:flex;
  align-items:center;
  justify-content:center;
  color:black;
  font-weight:bold;
  transition: width 0.2s;
}

.transparent-icon {
  background: transparent;
  font-size: 32px;
  text-align: center;
  line-height: 32px;
}

#search-box, #control-panel { display: none; }
</style>
</head>

<body>

<div id="color-panel"></div>
<div id="map"></div>

<div id="loading-container">
  <div id="loading-bar">0%</div>
</div>

<div id="search-box">
  <input type="text" id="address-input" placeholder="S√∂k adress...">
  <button onclick="searchAddress()">S√∂k</button>
  <button id="reset-button" onclick="resetSearch()">√Öterst√§ll</button>
</div>

<div id="control-panel">

  <div class="filter-panel">
    <label>
      <input type="checkbox" id="filter-vitvaror" checked>
      Vitvaror
    </label>
    <label>
      <input type="checkbox" id="filter-tvattstugor" checked>
      Tv√§ttstugor
    </label>
  </div>

  <button type="button" class="collapsible nice-button">
    <span>Teknikerlista</span>
    <span class="arrow">‚ñº</span>
  </button>
  <div class="content">
    <button id="reload-button" onclick="loadCSV()">Ladda om tekniker</button>
    <div id="technician-list"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
const map = L.map("map", { zoomControl: false }).setView([59.33, 18.06], 9);
L.control.zoom({ position: "bottomright" }).addTo(map);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{ attribution: "¬© OpenStreetMap"}).addTo(map);

let technicians = [];
let allMarkers = [];
let addressOffsets = {};
let selectedTechnician = null;
const initialView = { center:[59.33,18.06], zoom:9 };

const loadingContainer = document.getElementById("loading-container");
const loadingBar = document.getElementById("loading-bar");
let searchMarker = null;

// Geocoding
async function geocode(address){
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
  const res = await fetch(url,{headers:{ "User-Agent":"ErgonovaTekniker/1.0" }});
  const data = await res.json();
  if(!data.length) return null;
  return [parseFloat(data[0].lat),parseFloat(data[0].lon)];
}

function applyOffset(latlng, key){
  if(!addressOffsets[key]) addressOffsets[key]=0;
  const offset = 0.00135 * addressOffsets[key];
  addressOffsets[key]++;
  return [latlng[0]+offset, latlng[1]];
}

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

// Load CSV
async function loadCSV(){
  loadingContainer.style.display = "block";
  loadingBar.style.width = "0%";
  loadingBar.textContent = "0%";

  allMarkers.forEach(o => map.removeLayer(o.marker));
  allMarkers = [];
  addressOffsets = {};
  technicians = [];

  const response = await fetch("https://raw.githubusercontent.com/Perkanboy/Teknikerlista/main/list.csv");
  const csvText = await response.text();
  const rows = Papa.parse(csvText,{header:true,skipEmptyLines:true}).data;

  let total = 0;
  rows.forEach(r => total += 1 + r.adresser.split("|").filter(a=>a.trim()).length);
  let loaded = 0;
  function updateLoading(){ 
    const p = Math.round((loaded/total)*100); 
    loadingBar.style.width = p+"%"; 
    loadingBar.textContent = p+"%"; 
  }

  for(const row of rows){
    const name = row.namn;
    const homeAddress = row.hemadress;
    const color = row.f√§rg || "#ff0000";
    const resource = row.resurs || "";
    const addressList = row.adresser.split("|").map(a=>a.trim()).filter(a=>a);

    technicians.push({ name, color, resource, home:{address:homeAddress}, addresses:addressList });

    const homeLat = await geocode(homeAddress);
    if(homeLat){
      const adj = applyOffset(homeLat, homeAddress);
      const marker = L.marker(adj,{
        icon:L.divIcon({
          html:"üè†",
          className:"transparent-icon",
          iconSize:[50,50],
          iconAnchor:[25,25]
        })
      })
      .addTo(map)
      .bindTooltip(`${name}<br>${resource}`,{permanent:true,direction:"right",className:"house-label",offset:[10,0]});
      const el = marker.getTooltip().getElement();
      if(el){ el.style.backgroundColor = color; el.style.color = "#fff"; }
      allMarkers.push({ marker, techName: name, resource });
      loaded++; updateLoading();
      await sleep(2 + Math.random()*2);
    }

    for(const addr of addressList){
      const lat = await geocode(addr);
      if(lat){
        const adj = applyOffset(lat, addr);
        const marker = L.marker(adj,{
          icon:L.divIcon({
            html:"üìç",
            className:"transparent-icon",
            iconSize:[50,50],
            iconAnchor:[25,25]
          })
        })
        .addTo(map)
        .bindTooltip(`${name}<br>${resource}`,{permanent:true,direction:"right",className:"house-label",offset:[10,0]});
        const el = marker.getTooltip().getElement();
        if(el){ el.style.backgroundColor = color; el.style.color = "#fff"; }
        allMarkers.push({ marker, techName: name, resource });
        loaded++; updateLoading();
        await sleep(10 + Math.random()*10);
      }
    }
  }

  renderTechnicianList();
  renderColorPanel();
  applyResourceFilter();

  loadingBar.style.width = "100%";
  loadingBar.textContent = "100%";
  setTimeout(() => {
    loadingContainer.style.display = "none";
    document.getElementById("search-box").style.display = "flex";
    document.getElementById("control-panel").style.display = "block";
  }, 300);
}

// Render f√§rgpanel
function renderColorPanel(){
  const p = document.getElementById("color-panel");
  p.innerHTML="";
  technicians.forEach((t,i)=>{
    const d = document.createElement("div");
    d.className="tech-color";
    d.id="tech-color-"+i;
    d.dataset.techName = t.name;
    d.dataset.resource = t.resource;
    d.innerHTML = `<div class="tech-color-box" style="background:${t.color}"></div>${t.name}`;
    d.onclick = () => toggleTechnicianFilter(t.name);
    p.appendChild(d);
  });
}

// Toggle tekniker filter via f√§rgpanel
function toggleTechnicianFilter(name){
  if(selectedTechnician === name){
    selectedTechnician = null;
  } else {
    selectedTechnician = name;
  }
  applyResourceFilter();
}

// Render teknikerlista
function renderTechnicianList(){
  const c = document.getElementById("technician-list");
  c.innerHTML="";
  technicians.forEach(t=>{
    const d = document.createElement("div");
    d.innerHTML = `<strong>${t.name}</strong><br>Hem: ${t.home.address}<br>Resurs: ${t.resource}<br>Adresser: ${t.addresses.join(", ")}`;
    c.appendChild(d);
  });
}

// S√∂k adress
async function searchAddress(){
  const q = document.getElementById("address-input").value;
  if(!q) return alert("Skriv en adress");

  const coords = await geocode(q);
  if(!coords) return alert("Adressen hittades inte");

  if(searchMarker){ map.removeLayer(searchMarker); searchMarker = null; }

  searchMarker = L.marker(coords, {
    icon: L.divIcon({ html: "üîµ", className: "transparent-icon", iconSize: [50,50], iconAnchor:[25,25] })
  }).addTo(map).bindTooltip(q,{permanent:true,direction:"top",className:"house-label",offset:[0,-10]});

  const el = searchMarker.getTooltip().getElement();
  if(el){ el.style.backgroundColor="#2196F3"; el.style.color="#fff"; }

  map.setView(coords, 15);

  const distances = allMarkers.map(o=>{
    const ll = o.marker.getLatLng();
    return { techName: o.techName, distance: Math.hypot(ll.lat-coords[0], ll.lng-coords[1]) };
  });

  distances.sort((a,b)=>a.distance-b.distance);
  const nearestTwo = distances.slice(0,2).map(d=>d.techName);

  technicians.forEach((t,i)=>{
    const el = document.getElementById("tech-color-"+i);
    if(el && t.name !== selectedTechnician){
      el.style.backgroundColor = "white";
      el.style.color = "#000";
    }
  });

  technicians.forEach((t,i)=>{
    if(nearestTwo.includes(t.name) && t.name !== selectedTechnician){
      const el = document.getElementById("tech-color-"+i);
      if(el){ el.style.backgroundColor="#FF5C00"; el.style.color="#000"; }
    }
  });
}

// Reset s√∂kning
function resetSearch() {
  if(searchMarker){
    map.removeLayer(searchMarker);
    searchMarker = null;
  }
  technicians.forEach((t,i)=>{
    const el = document.getElementById("tech-color-"+i);
    if(el){
      el.style.backgroundColor = "white";
      el.style.color = "#000";
    }
  });
  selectedTechnician = null;
  applyResourceFilter();
  document.getElementById("address-input").value = "";
  // Zooma ut till startvy
  map.setView(initialView.center, initialView.zoom);
}

// Filter logik
function applyResourceFilter(){
  const vitvarorChecked = document.getElementById("filter-vitvaror").checked;
  const tvattstugorChecked = document.getElementById("filter-tvattstugor").checked;

  allMarkers.forEach(o=>{
    let show = true;

    if(selectedTechnician){
      show = o.techName === selectedTechnician;
    } else if(vitvarorChecked && !tvattstugorChecked){
      show = o.resource.toLowerCase().includes("vitvar");
    } else if(!vitvarorChecked && tvattstugorChecked){
      show = o.resource.toLowerCase().includes("tv√§tt");
    } else if(vitvarorChecked && tvattstugorChecked){
      show = true;
    } else {
      show = false;
    }

    if(show){ if(!map.hasLayer(o.marker)) o.marker.addTo(map); }
    else { if(map.hasLayer(o.marker)) map.removeLayer(o.marker); }
  });

  technicians.forEach((t,i)=>{
    const el = document.getElementById("tech-color-"+i);
    if(el){
      if(selectedTechnician){
        el.style.display = (t.name === selectedTechnician) ? "flex" : "none";
      } else {
        const match = (vitvarorChecked && t.resource.toLowerCase().includes("vitvar")) ||
                      (tvattstugorChecked && t.resource.toLowerCase().includes("tv√§tt"));
        el.style.display = match ? "flex" : "none";
      }
    }
  });
}

// Eventlisteners
document.getElementById("filter-vitvaror").addEventListener("change", applyResourceFilter);
document.getElementById("filter-tvattstugor").addEventListener("change", applyResourceFilter);

// Enter-tangent f√∂r s√∂kning
document.getElementById("address-input").addEventListener("keypress", function(e){
  if(e.key === "Enter"){
    searchAddress();
  }
});

// Collapsible knapp
const coll = document.querySelector(".collapsible");
coll.onclick = function(){
  this.classList.toggle("active");
  const c = this.nextElementSibling;
  c.style.display = c.style.display==="block"?"none":"block";
}

// Starta
window.addEventListener("DOMContentLoaded", loadCSV);
</script>

</body>
</html>



